import{r as a,j as e}from"./index-PONFeB8c.js";function $({onSelectRealTime:i}){const[l,f]=a.useState(null),p={other:e.jsxs("div",{className:"max-w-xs p-2 bg-white border rounded shadow-lg",children:[e.jsx("h3",{className:"font-bold mb-1",children:"Regular Model"}),e.jsx("p",{className:"text-sm",children:"Provides consistent responses with no delay, ideal for structured conversations."})]}),realtime:e.jsxs("div",{className:"max-w-xs p-2 bg-white border rounded shadow-lg",children:[e.jsx("h3",{className:"font-bold mb-1",children:"Real-Time Model"}),e.jsx("p",{className:"text-sm",children:"Responds instantly, adapting tone and speed as you speak, perfect for dynamic, conversational interactions."})]})};return e.jsxs("div",{className:"menu-container flex flex-col items-center justify-center h-screen bg-gray-100",children:[e.jsx("h1",{className:"text-2xl font-bold mb-8",children:"Select Model"}),e.jsxs("div",{className:"menu-options flex gap-4 relative",children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{className:"menu-button px-6 py-3 bg-gray-400 text-white rounded cursor-not-allowed",disabled:!0,children:"Other Models"}),e.jsx("div",{className:"absolute -top-0.5 -right-1 w-4 h-4 bg-yellow-400 rounded-full flex items-center justify-center cursor-help hover:bg-gray-400 transition-colors",onMouseEnter:()=>f("other"),onMouseLeave:()=>f(null),children:e.jsx("span",{className:"text-gray-600 text-xs",children:"i"})})]}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{className:"menu-button px-6 py-3 bg-blue-600 text-white rounded hover:bg-blue-500",onClick:i,children:"Real-Time Model"}),e.jsx("div",{className:"absolute -top-0.5 -right-1 w-4 h-4 bg-yellow-400 rounded-full flex items-center justify-center cursor-help hover:bg-gray-400 transition-colors",onMouseEnter:()=>f("realtime"),onMouseLeave:()=>f(null),children:e.jsx("span",{className:"text-gray-600 text-xs",children:"i"})})]}),l&&e.jsx("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-2",children:p[l]})]})]})}function G({config:i,setConfig:l,onCreatePrompt:f,onModelCreate:p}){const[x,g]=a.useState([]);a.useEffect(()=>{async function t(){try{await navigator.mediaDevices.getUserMedia({audio:!0});const m=(await navigator.mediaDevices.enumerateDevices()).filter(c=>c.kind==="audioinput");g(m),m.length>0&&!i.microphoneId&&l(c=>({...c,microphoneId:m[0].deviceId}))}catch(n){console.error("Error accessing microphone devices:",n)}}t()},[l,i.microphoneId]);const w=[{value:"alloy",label:"Alloy"},{value:"ash",label:"Ash"},{value:"ballad",label:"Ballad"},{value:"coral",label:"Coral"},{value:"echo",label:"Echo"},{value:"sage",label:"Sage"},{value:"shimmer",label:"Shimmer"},{value:"verse",label:"Verse"}];return e.jsx("div",{className:"flex items-center justify-center min-h-screen p-4",children:e.jsxs("div",{className:"configuration-container max-w-lg mx-auto mt-12 p-6 bg-white rounded shadow",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Real-Time Model Configuration"}),e.jsxs("div",{className:"config-item mb-4",children:[e.jsx("label",{htmlFor:"voiceSelect",className:"block mb-1 font-medium",children:"Select Voice:"}),e.jsx("select",{id:"voiceSelect",className:"w-full border rounded p-2",value:i.voice,onChange:t=>{console.log("Selected voice:",t.target.value),l(n=>({...n,voice:t.target.value}))},children:w.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{className:"config-item mb-4",children:[e.jsx("label",{htmlFor:"instructionInput",className:"block mb-1 font-medium",children:"Instruction:"}),e.jsx("textarea",{id:"instructionInput",className:"w-full border rounded p-2",value:i.instructions,onChange:t=>{const n=t.target.value.slice(0,1e3);l(m=>({...m,instructions:n}))},placeholder:"e.g. Speak like a kind young programmer with extensive experience."})]}),e.jsx("div",{className:"config-item mb-4",children:e.jsx("button",{className:"px-4 py-2 bg-green-600 text-white rounded hover:bg-green-500",onClick:f,children:"Create Prompt"})}),e.jsxs("div",{className:"config-item mb-4",children:[e.jsx("label",{htmlFor:"micSelect",className:"block mb-1 font-medium",children:"Select Microphone:"}),e.jsx("select",{id:"micSelect",className:"w-full border rounded p-2",value:i.microphoneId,onChange:t=>l(n=>({...n,microphoneId:t.target.value})),children:x.map(t=>e.jsx("option",{value:t.deviceId,children:t.label||"Microphone"},t.deviceId))})]}),e.jsxs("div",{className:"config-item mb-4 flex items-center",children:[e.jsx("input",{id:"micToggle",type:"checkbox",checked:i.startWithMicDisabled,onChange:t=>l(n=>({...n,startWithMicDisabled:t.target.checked})),className:"mr-2"}),e.jsx("label",{htmlFor:"micToggle",className:"font-medium",children:"Start dialogue with microphone disabled"})]}),e.jsx("div",{className:"config-item",children:e.jsx("button",{className:"w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500",onClick:p,children:"Create Model"})})]})})}const W=({audioContext:i,analyser:l,isMuted:f})=>{const p=a.useRef(null),x=a.useRef(null),g=a.useRef(!0),w=a.useRef([]),t=a.useRef([]),n=a.useRef(0),m=a.useRef(1);return a.useEffect(()=>{const c=p.current;if(!c)return;const s=c.getContext("2d");g.current=!0;const S=()=>{i&&i.state==="suspended"&&i.resume()};c.addEventListener("touchstart",S),c.addEventListener("click",S);const M=window.devicePixelRatio||1,E=400,y=E*M,u=E*M;c.width=y,c.height=u,c.style.width=`${E}px`,c.style.height=`${E}px`;const h=Math.PI,j=12;n.current=140*M;const v={x:y/2,y:u/2},C=(o,r,d)=>o*(1-d)+r*d,R=(o,r)=>Math.random()*(r-o)+o,k=(o,r)=>(o%r+r)%r,T=()=>{t.current=[s.createRadialGradient(y/2,u/2,0,y/2,u/2,n.current),s.createLinearGradient(0,0,y,0),s.createLinearGradient(0,0,y,0),s.createLinearGradient(0,0,y,0)],t.current[0].addColorStop(0,"rgba(255,255,255,0.9)"),t.current[0].addColorStop(1,"rgba(255,255,255,0.4)"),t.current[1].addColorStop(0,"#70d7ff"),t.current[1].addColorStop(1,"#a8d8ff"),t.current[2].addColorStop(0,"#d8a8ff"),t.current[2].addColorStop(1,"#e0c3fc"),t.current[3].addColorStop(0,"#ff9be3"),t.current[3].addColorStop(1,"#ffb3e6")},L=()=>{w.current=[];for(let o=0;o<3;o++){const r=[];for(let d=0;d<j;d++){const N=h*2/j*d;r.push({x:v.x+n.current*Math.cos(N),y:v.y+n.current*Math.sin(N),radian:N,range:R(18,25),phase:R(0,h*2),baseRadius:n.current})}w.current.push(r)}},P=(o,r)=>{s.fillStyle=r,s.beginPath(),s.moveTo((o[k(-1,j)].x+o[0].x)/2,(o[k(-1,j)].y+o[0].y)/2);for(let d=0;d<o.length;d++)s.quadraticCurveTo(o[d].x,o[d].y,(o[d].x+o[k(d+1,j)].x)/2,(o[d].y+o[k(d+1,j)].y)/2);s.closePath(),s.fill()},O=()=>{if(!l||!g.current)return 0;const o=new Uint8Array(l.frequencyBinCount);l.getByteFrequencyData(o);const r=o.reduce((d,N)=>d+N,0);return Math.min(r/o.length/255,.5)},I=()=>{if(!g.current)return;const o=O(),r=C(.1,o,1),d=1;m.current=C(m.current,d,.15),s.clearRect(0,0,y,u),s.globalCompositeOperation="screen",s.globalAlpha=.9,s.beginPath(),s.arc(v.x,v.y,n.current*.6,0,2*Math.PI),s.fillStyle=t.current[0],s.fill(),w.current.forEach((N,F)=>{const A=F+1;t.current[A]&&(N.forEach(b=>{const B=1+r*1.5;b.phase+=R(-.05,.05)*m.current*B;let D=n.current*m.current;D+=Math.min(r*100*M,50*M);const U=b.range*Math.sin(b.phase*B),z=v.x+(D+U)*Math.cos(b.radian),_=v.y+(D+U)*Math.sin(b.radian);b.x=C(b.x,z,.2),b.y=C(b.y,_,.2),b.radian+=h/320*(1/m.current)}),s.shadowColor="#70d7ff55",s.shadowBlur=20*M,P(N,t.current[A]),s.shadowBlur=0)}),x.current=requestAnimationFrame(I)};return T(),L(),I(),()=>{g.current=!1,cancelAnimationFrame(x.current),c.removeEventListener("touchstart",S),c.removeEventListener("click",S)}},[l,i]),e.jsx("canvas",{ref:p,className:"absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 z-0",style:{imageRendering:"crisp-edges"}})};function q({sessionState:i,toggleMute:l,terminateSession:f,audioContext:p,analyser:x}){const[g,w]=a.useState(300);a.useEffect(()=>{const n=setInterval(()=>{w(m=>m>0?m-1:0)},1e3);return()=>clearInterval(n)},[]),a.useEffect(()=>{g===0&&f()},[g,f]);const t=`${Math.floor(g/60).toString().padStart(2,"0")}:${(g%60).toString().padStart(2,"0")}`;return a.useEffect(()=>{const n=()=>{p&&p.state==="suspended"&&p.resume()};return document.addEventListener("touchstart",n),document.addEventListener("click",n),()=>{document.removeEventListener("touchstart",n),document.removeEventListener("click",n)}},[p]),e.jsxs("div",{className:"session-container relative flex flex-col items-center justify-center h-screen bg-gray-50",children:[e.jsx("div",{className:"absolute top-4 right-4 bg-white px-4 py-2 rounded shadow z-10",children:e.jsx("span",{className:"font-mono",children:t})}),e.jsx("div",{className:"mb-16",children:e.jsx(W,{audioContext:p,analyser:x,isMuted:i.muted})}),e.jsxs("div",{className:"absolute bottom-24 flex gap-4 z-10",children:[e.jsx("button",{className:"p-3 bg-gray-200 hover:bg-gray-300 rounded-full transition-colors shadow-md flex items-center justify-center",onClick:l,children:e.jsx("i",{className:"material-icons text-xl",children:i.muted?"mic_off":"mic"})}),e.jsx("button",{className:"p-3 bg-red-100 hover:bg-red-200 rounded-full transition-colors shadow-md flex items-center justify-center",onClick:f,children:e.jsx("i",{className:"material-icons text-xl",children:"meeting_room"})})]})]})}function J(){const[i,l]=a.useState("menu"),[f,p]=a.useState(""),[x,g]=a.useState({voice:"alloy",instructions:"",microphoneId:"",startWithMicDisabled:!1}),[w,t]=a.useState({status:"idle",muted:!1}),n=a.useRef(null),m=a.useRef(null),c=a.useRef(null),s=a.useRef(null),S=a.useRef(null);async function M(){console.log("Starting Real-Time session with configuration:",x);try{const h=await(await fetch("/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4o-realtime-preview-2024-12-17",voice:x.voice,instructions:x.instructions})})).json();if(console.log("Token data:",h),h.error)throw new Error("Error creating session: "+JSON.stringify(h.error));if(!h.client_secret)throw new Error("client_secret missing in response: "+JSON.stringify(h));const j=h.client_secret.value,v=new RTCPeerConnection;n.current=v,c.current=document.createElement("audio"),c.current.autoplay=!0,v.ontrack=r=>{r.streams&&r.streams[0]&&(c.current.srcObject=r.streams[0])};const C={audio:x.microphoneId?{deviceId:{exact:x.microphoneId}}:!0},R=await navigator.mediaDevices.getUserMedia(C);x.startWithMicDisabled&&(R.getAudioTracks().forEach(r=>{r.enabled=!1}),t(r=>({...r,muted:!0}))),R.getAudioTracks().forEach(r=>{v.addTrack(r,R)});const k=v.createDataChannel("oai-events");m.current=k,k.onopen=()=>{console.log("Data channel is open")},k.onmessage=r=>{console.log("Data channel message:",r.data)};const T=await v.createOffer();await v.setLocalDescription(T);const L=`https://api.openai.com/v1/realtime?model=${encodeURIComponent(x.model)}`,I={type:"answer",sdp:await(await fetch(L,{method:"POST",headers:{Authorization:`Bearer ${j}`,"Content-Type":"application/sdp"},body:T.sdp})).text()};await v.setRemoteDescription(I),s.current||(s.current=new(window.AudioContext||window.webkitAudioContext)),S.current=s.current.createAnalyser(),S.current.fftSize=256,await(async()=>{const r=s.current.createMediaStreamDestination(),d=await navigator.mediaDevices.getUserMedia({audio:!0});s.current.createMediaStreamSource(d).connect(r),s.current.createMediaElementSource(c.current).connect(r),r.stream.getTracks().forEach(A=>{s.current.createMediaStreamSource(new MediaStream([A])).connect(S.current)})})(),t(r=>({...r,status:"listening..."})),l("session")}catch(u){console.error("Failed to start session:",u),p(u.message)}}async function E(){console.log("Terminating session");try{await fetch("/end",{method:"POST"}),n.current&&(n.current.close(),n.current=null),m.current&&(m.current.close(),m.current=null),s.current&&(await s.current.close(),s.current=null),c.current&&(c.current.pause(),c.current=null)}catch(u){console.error("Error ending session:",u)}t({status:"idle",muted:!1}),l("menu")}function y(){n.current&&n.current.getSenders().forEach(h=>{h.track&&h.track.kind==="audio"&&(h.track.enabled=!h.track.enabled)}),t(u=>({...u,muted:!u.muted})),console.log(w.muted?"Microphone unmuted":"Microphone muted")}return e.jsxs("div",{className:"app-container",children:[f&&e.jsxs("div",{className:"api-error fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded z-50",children:[f,e.jsx("button",{onClick:()=>p(""),className:"ml-4 text-white font-bold",children:"X"})]}),a.useEffect(()=>{if(f){const u=setTimeout(()=>p(""),5e3);return()=>clearTimeout(u)}},[f]),i==="menu"&&e.jsx($,{onSelectRealTime:()=>l("configuration")}),i==="configuration"&&e.jsx(G,{config:x,setConfig:g,onCreatePrompt:async()=>{try{const h=await(await fetch("/prompt")).json();g(j=>({...j,instructions:h.instruction})),console.log("Received prompt:",h.instruction)}catch(u){console.error("Failed to fetch prompt:",u)}},onModelCreate:M}),i==="session"&&e.jsx(q,{sessionState:w,toggleMute:y,terminateSession:E,audioContext:s.current,analyser:S.current}),i==="configuration"&&e.jsx("button",{onClick:()=>l("menu"),className:"fixed top-4 left-4 p-2 bg-gray-200 hover:bg-gray-300 rounded-full",title:"Back to main",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 19l-7-7m0 0l7-7m-7 7h18"})})})]})}function H(){return e.jsx(J,{})}export{H as default};
